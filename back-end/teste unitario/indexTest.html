<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testes Unit√°rios - MedSystem Login</title>
    <!-- Corrige o caminho do CSS para garantir o carregamento correto -->
    <link rel="stylesheet" href="./css/indexTest.css">
</head>
<body>
    <nav class="nav-panel">
        <a href="indexTest.html" class="nav-btn active">Login</a>
        <a href="pacientesTest.html" class="nav-btn">Pacientes</a>
        <a href="pacienteNovosTest.html" class="nav-btn">Novo Paciente</a>
        <a href="reportsTest.html" class="nav-btn">Relat√≥rios</a>
    </nav>
    <div class="header">
        <h1>üß™ Testes Unit√°rios<br>MedSystem Login</h1>
    </div>
    <div class="container">
        <div id="test-results"></div>
        <div class="summary" id="summary" style="display: none;"></div>
        <button class="run-tests-btn" onclick="runAllTests()">Executar Todos os Testes</button>
    </div>
    <script>
        // Simula√ß√£o das fun√ß√µes do sistema original
        const validUsers = {
            'admin': {
                password: 'admin123',
                name: 'Administrador',
                role: 'admin',
                crm: 'ADMIN001'
            },
            'dr.silva': {
                password: 'medico123',
                name: 'Dr. Jo√£o Silva',
                role: 'medico',
                crm: 'CRM12345'
            },
            'dra.santos': {
                password: 'medica123',
                name: 'Dra. Maria Santos',
                role: 'medico',
                crm: 'CRM67890'
            }
        };

        // Fun√ß√£o para carregar usu√°rios cadastrados (simulada)
        function loadRegisteredUsers() {
            const registeredUsers = JSON.parse(sessionStorage.getItem('medSystemUsers') || '[]');
            const dynamicUsers = {};

            registeredUsers.forEach(user => {
                const username = user.email.split('@')[0].toLowerCase();
                dynamicUsers[username] = {
                    password: user.password,
                    name: user.fullName,
                    role: 'medico',
                    crm: user.crm,
                    email: user.email,
                    specialty: user.specialty,
                    phone: user.phone,
                    isRegistered: true
                };
            });

            return dynamicUsers;
        }

        // Fun√ß√£o para obter todos os usu√°rios
        function getAllUsers() {
            const registeredUsers = loadRegisteredUsers();
            return { ...validUsers, ...registeredUsers };
        }

        // Fun√ß√£o de valida√ß√£o de login
        function validateLogin(username, password) {
            const allUsers = getAllUsers();
            
            if (!allUsers[username]) {
                return { success: false, message: 'Usu√°rio n√£o encontrado!' };
            }

            if (allUsers[username].password !== password) {
                return { success: false, message: 'Senha incorreta!' };
            }

            return { success: true, message: 'Login v√°lido!', user: allUsers[username] };
        }

        // Fun√ß√£o para salvar sess√£o
        function saveUserSession(username, userData) {
            const sessionData = {
                username: username,
                name: userData.name,
                role: userData.role,
                crm: userData.crm || userData.coren || userData.id,
                email: userData.email || '',
                specialty: userData.specialty || '',
                phone: userData.phone || '',
                loginTime: new Date().toISOString(),
                isLoggedIn: true,
                isRegistered: userData.isRegistered || false
            };

            sessionStorage.setItem('medSystemUser', JSON.stringify(sessionData));
            return sessionData;
        }

        // Fun√ß√£o para verificar sess√£o existente
        function checkExistingSession() {
            const existingSession = sessionStorage.getItem('medSystemUser');
            if (existingSession) {
                try {
                    const userData = JSON.parse(existingSession);
                    return userData.isLoggedIn ? userData : null;
                } catch (error) {
                    sessionStorage.removeItem('medSystemUser');
                    return null;
                }
            }
            return null;
        }

        // Sistema de testes simples
        let testResults = [];

        function assert(condition, message) {
            if (condition) {
                testResults.push({ status: 'PASS', message: message });
                return true;
            } else {
                testResults.push({ status: 'FAIL', message: message });
                return false;
            }
        }

        function assertEquals(actual, expected, message) {
            return assert(actual === expected, `${message} - Esperado: ${expected}, Atual: ${actual}`);
        }

        function assertNotNull(value, message) {
            return assert(value !== null && value !== undefined, `${message} - Valor n√£o deve ser null/undefined`);
        }

        function assertNull(value, message) {
            return assert(value === null || value === undefined, `${message} - Valor deve ser null/undefined`);
        }

        // Testes das fun√ß√µes
        function testLoadRegisteredUsers() {
            console.log('üß™ Testando loadRegisteredUsers...');
            
            // Limpa dados de teste
            sessionStorage.removeItem('medSystemUsers');
            
            // Teste com dados vazios
            let result = loadRegisteredUsers();
            assert(Object.keys(result).length === 0, 'Deve retornar objeto vazio quando n√£o h√° usu√°rios cadastrados');
            
            // Teste com dados simulados
            const testUsers = [{
                email: 'teste@email.com',
                password: '123456',
                fullName: 'Dr. Teste',
                crm: 'CRM123',
                specialty: 'Cardiologia',
                phone: '11999999999'
            }];
            
            sessionStorage.setItem('medSystemUsers', JSON.stringify(testUsers));
            result = loadRegisteredUsers();
            
            assert(Object.keys(result).length === 1, 'Deve retornar 1 usu√°rio cadastrado');
            assert(result['teste'] !== undefined, 'Deve criar username baseado no email');
            assert(result['teste'].name === 'Dr. Teste', 'Deve mapear nome corretamente');
            assert(result['teste'].isRegistered === true, 'Deve marcar como usu√°rio registrado');
        }

        function testGetAllUsers() {
            console.log('üß™ Testando getAllUsers...');
            
            const allUsers = getAllUsers();
            
            assert(Object.keys(allUsers).length >= 3, 'Deve conter pelo menos os usu√°rios pr√©-definidos');
            assert(allUsers['admin'] !== undefined, 'Deve conter usu√°rio admin');
            assert(allUsers['dr.silva'] !== undefined, 'Deve conter usu√°rio dr.silva');
            assert(allUsers['dra.santos'] !== undefined, 'Deve conter usu√°rio dra.santos');
        }

        function testValidateLogin() {
            console.log('üß™ Testando validateLogin...');
            
            // Teste login v√°lido
            let result = validateLogin('admin', 'admin123');
            assert(result.success === true, 'Login v√°lido deve retornar success = true');
            assert(result.user.name === 'Administrador', 'Deve retornar dados do usu√°rio');
            
            // Teste usu√°rio inexistente
            result = validateLogin('inexistente', 'senha');
            assert(result.success === false, 'Usu√°rio inexistente deve retornar success = false');
            assert(result.message === 'Usu√°rio n√£o encontrado!', 'Deve retornar mensagem de usu√°rio n√£o encontrado');
            
            // Teste senha incorreta
            result = validateLogin('admin', 'senhaerrada');
            assert(result.success === false, 'Senha incorreta deve retornar success = false');
            assert(result.message === 'Senha incorreta!', 'Deve retornar mensagem de senha incorreta');
        }

        function testSaveUserSession() {
            console.log('üß™ Testando saveUserSession...');
            
            // Limpa sess√£o anterior
            sessionStorage.removeItem('medSystemUser');
            
            const userData = {
                name: 'Teste User',
                role: 'medico',
                crm: 'CRM123',
                email: 'teste@email.com'
            };
            
            const sessionData = saveUserSession('teste', userData);
            
            assert(sessionData.username === 'teste', 'Deve salvar username corretamente');
            assert(sessionData.name === 'Teste User', 'Deve salvar nome corretamente');
            assert(sessionData.isLoggedIn === true, 'Deve marcar como logado');
            assertNotNull(sessionData.loginTime, 'Deve salvar hor√°rio de login');
            
            // Verifica se foi salvo no sessionStorage
            const savedSession = sessionStorage.getItem('medSystemUser');
            assertNotNull(savedSession, 'Deve salvar sess√£o no sessionStorage');
        }

        function testCheckExistingSession() {
            console.log('üß™ Testando checkExistingSession...');
            
            // Teste sem sess√£o
            sessionStorage.removeItem('medSystemUser');
            let result = checkExistingSession();
            assertNull(result, 'Deve retornar null quando n√£o h√° sess√£o');
            
            // Teste com sess√£o v√°lida
            const sessionData = {
                username: 'teste',
                name: 'Teste User',
                isLoggedIn: true,
                loginTime: new Date().toISOString()
            };
            sessionStorage.setItem('medSystemUser', JSON.stringify(sessionData));
            
            result = checkExistingSession();
            assertNotNull(result, 'Deve retornar dados da sess√£o quando existe');
            assert(result.username === 'teste', 'Deve retornar username correto');
            assert(result.isLoggedIn === true, 'Deve confirmar que est√° logado');
            
            // Teste com sess√£o inv√°lida (usu√°rio n√£o logado)
            sessionData.isLoggedIn = false;
            sessionStorage.setItem('medSystemUser', JSON.stringify(sessionData));
            result = checkExistingSession();
            assertNull(result, 'Deve retornar null quando usu√°rio n√£o est√° logado');
        }

        function testUsernameSuggestion() {
            console.log('üß™ Testando sugest√£o de username...');
            
            // Simula a l√≥gica de sugest√£o de username
            function suggestUsername(email) {
                if (email.includes('@')) {
                    return email.split('@')[0].toLowerCase();
                }
                return null;
            }
            
            let suggestion = suggestUsername('dr.silva@hospital.com');
            assert(suggestion === 'dr.silva', 'Deve sugerir username baseado no email');
            
            suggestion = suggestUsername('admin@sistema.com');
            assert(suggestion === 'admin', 'Deve converter para lowercase');
            
            suggestion = suggestUsername('usuariosememail');
            assertNull(suggestion, 'Deve retornar null para entrada sem @');
        }

        // Fun√ß√£o para executar todos os testes
        function runAllTests() {
            console.log('üöÄ Iniciando testes...');
            testResults = [];
            
            // Executa todos os testes
            testLoadRegisteredUsers();
            testGetAllUsers();
            testValidateLogin();
            testSaveUserSession();
            testCheckExistingSession();
            testUsernameSuggestion();
            
            // Exibe resultados
            displayResults();
        }

        // Testes agrupados por se√ß√µes amig√°veis
        function displayResults() {
            const resultsDiv = document.getElementById('test-results');
            const summaryDiv = document.getElementById('summary');
            let passCount = 0, failCount = 0, html = '';

            // Novo agrupamento mais amig√°vel
            const testSections = {
                'Usu√°rios Cadastrados': [],
                'Todos os Usu√°rios': [],
                'Valida√ß√£o de Login': [],
                'Sess√£o do Usu√°rio': [],
                'Sess√£o Existente': [],
                'Sugest√£o de Username': []
            };

            testResults.forEach(result => {
                if (result.status === 'PASS') passCount++;
                else failCount++;

                // Agrupamento por palavras-chave
                const msg = result.message.toLowerCase();
                if (msg.includes('usu√°rios cadastrados')) testSections['Usu√°rios Cadastrados'].push(result);
                else if (msg.includes('pr√©-definidos') || msg.includes('getallusers')) testSections['Todos os Usu√°rios'].push(result);
                else if (msg.includes('login') || msg.includes('senha')) testSections['Valida√ß√£o de Login'].push(result);
                else if (msg.includes('salvar sess√£o') || msg.includes('saveusersession')) testSections['Sess√£o do Usu√°rio'].push(result);
                else if (msg.includes('existente') || msg.includes('checkexistingsession')) testSections['Sess√£o Existente'].push(result);
                else if (msg.includes('username') || msg.includes('email')) testSections['Sugest√£o de Username'].push(result);
            });

            // Renderiza√ß√£o das se√ß√µes
            Object.entries(testSections).forEach(([section, items]) => {
                if (items.length > 0) {
                    html += `<div class="test-section">
                        <h3>üìã ${section}</h3>`;
                    items.forEach(result => {
                        const className = result.status === 'PASS' ? 'test-pass' : 'test-fail';
                        const icon = result.status === 'PASS' ? '‚úÖ' : '‚ùå';
                        html += `<div class="test-result ${className}">${icon} ${result.message}</div>`;
                    });
                    html += `</div>`;
                }
            });

            resultsDiv.innerHTML = html;

            // Resumo visual mais bonito com cart√µes
            const totalTests = passCount + failCount;
            const successRate = totalTests > 0 ? ((passCount / totalTests) * 100).toFixed(1) : 0;
            summaryDiv.innerHTML = `
                <div class="summary-card">
                    <strong>Total</strong>
                    <div class="value">${totalTests}</div>
                </div>
                <div class="summary-card">
                    <strong>Passou</strong>
                    <div class="value" style="color:#27ae60;">${passCount} ‚úÖ</div>
                </div>
                <div class="summary-card">
                    <strong>Falhou</strong>
                    <div class="value" style="color:#e74c3c;">${failCount} ‚ùå</div>
                </div>
                <div class="summary-card">
                    <strong>Sucesso</strong>
                    <div class="value">${successRate}%</div>
                </div>
            `;
            summaryDiv.style.display = 'flex';
            console.log(`‚úÖ Testes conclu√≠dos: ${passCount}/${totalTests} passaram`);
        }

        // Executa testes automaticamente ao carregar a p√°gina
        window.onload = function() {
            console.log('üîß Sistema de testes carregado. Clique no bot√£o para executar.');
        };
    </script>
</body>
</html>